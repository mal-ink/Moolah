<!--frontend kinda works what do we need to do
       - entry display needs to be cuter + matchting with the add entry button
       - fix login button
  backend
      - needs to be saved per account and retrieve every time user logs in
      - need to be able to email the contributors if they want to (this means we need another button or something in frontend)
-->
<!DOCTYPE html>
<html>  
<head> 
  <title>Money Owed</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <div class="nav-links">
      <div class="dropdown">
        <a href="index.html">Home</a>
        <div class="dropdown-content">
          <a href="about.html">About Us</a>
          <a href="contact us.html">Contact Us</a>
        </div>
      </div>
      <a href="Money Owed.html" class="active">Balances</a>
      <div class="dropdown" id="user-dropdown" style="display: none;">
        <span id="nav-user" class="dropbtn" style="color: black; cursor: pointer;"></span>
        <div class="logout">
          <button class="logout-button" id="logout-button">Logout</button>
        </div>
      </div>
      <a href="account.html" id="login-link" style="color: black;">Login</a>
    </div>
  </div>

   <!-- entries and descriptions for this page! -->
  <p style="color:rgb(4, 58, 4)">
    Log all expenses you need to remember! Whether it's paying your friend back for splitting a bill or a coworker who owes you for that morning coffee, put it all here!!
  </p> 
<hr> <div>
 
  <div id="entry-list">
  <div class="add-entry-card" onclick="openEntryForm()">
    <img src="Background .PNG" alt="Card background">
    <div class="overlay-text">
      <p class="card__plus">+</p>
      <p class="card__title">Add Entry</p>
    </div> 
  </div>
</div> 
  <div id="entry-form-modal" style="display: none;">
    <div class="entry-form-content">
      <span class="close-modal" onclick="closeEntryForm()">âœ–</span>
      <h2>New Expense Entry</h2>
      <form id="entryForm">
        <label for="entryTitle">Title</label>
        <input type="text" id="entryTitle" name="title" required>

        <label for="entryAmount">Amount</label>
        <input type="number" id="entryAmount" name="amount" required>

        <label for="entryContributors">Contributors' Emails</label>
        <textarea id="entryContributors" name="contributors" rows="2" placeholder="Enter emails separated by commas or new lines" required></textarea>

        <label for="entryDescription">Notes</label>
        <textarea id="entryDescription" name="notes" rows="3"></textarea>

        <button type="submit">Add Entry</button>
      </form>
    </div>
  </div>   

  <!-- javascript frontend stuff from here!! -->
<script> 
  const loggedInUser = localStorage.getItem('loggedInUser');
  const navUser = document.getElementById('nav-user');
  const userDropdown = document.getElementById('user-dropdown');
  const loginLink = document.getElementById('login-link');
  const logoutBtn = document.getElementById('logout-button');
  const form = document.getElementById('entryForm');
  const entryList = document.getElementById('entry-list');

  // username/login
  if (loggedInUser) {
    navUser.textContent = ` ${loggedInUser}`;
    userDropdown.style.display = 'inline-block';
    loginLink.style.display = 'none';
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('loggedInUser');
      window.location.reload();
    });
  } else {
    userDropdown.style.display = 'none';
    loginLink.style.display = 'inline-block';
  }

  function openEntryForm() {
    document.getElementById('entry-form-modal').style.display = 'flex';
  }

  function closeEntryForm() {
    document.getElementById('entry-form-modal').style.display = 'none';
  }

  // pulling entries when logged in
  async function loadEntries() {
    if (!loggedInUser) return;

    try {
      const response = await fetch(`http://localhost:3000/get-entries?username=${encodeURIComponent(loggedInUser)}`);
      const result = await response.json();

      if (response.ok) {
        const entries = result.entries || [];

        entries.forEach(entry => {
          const entryCard = document.createElement('div');
          entryCard.classList.add('entry-card');
          entryCard.innerHTML = `
           <strong>${entry.title}</strong><br>$${entry.amount}
            <div class="entry-details">
            <p><strong>Notes:</strong> ${entry.notes || "None"}</p>
           <p><strong>Contributors:</strong><br>${entry.contributors.replace(/\n/g, '<br>').replace(/, ?/g, '<br>')}</p>
            </div>
           <div class="trash-icon" title="Delete">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#a00">
            <path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/>
            </svg>
           </div>
          `;
          entryCard.querySelector('.trash-icon').addEventListener('click', async () => {
  const confirmDelete = confirm("Are you sure you want to delete this entry?");
  if (!confirmDelete) return;

  try {
    const res = await fetch('http://localhost:3000/delete-entry', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        username: loggedInUser,
        title: entry.title,
        amount: entry.amount
      })
    });

    const data = await res.json();

    if (res.ok) {
      entryCard.remove(); // Remove from the page
    } else {
      alert(data.error || "Could not delete entry.");
    }
  } catch (err) {
    console.error("Delete failed:", err);
    alert("Error deleting entry. Try again.");
  }
});


          entryList.appendChild(entryCard);
        });
      } else {
        console.error(result.error || "Failed to load entries.");
      }
    } catch (err) {
      console.error("Error loading entries:", err);
    }
  }

  // form submisstion
  form.addEventListener('submit', async function (e) {
    e.preventDefault();

    const title = document.getElementById('entryTitle').value.trim();
    const amount = document.getElementById('entryAmount').value.trim();
    const contributors = document.getElementById('entryContributors').value.trim();
    const description = document.getElementById('entryDescription').value.trim();

    if (!loggedInUser) {
      alert("You're not logged in.");
      return;
    }

    try {
      const response = await fetch('http://localhost:3000/add-entry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: loggedInUser,
          title,
          amount,
          contributors,
          notes: description
        })
      });

      const result = await response.json();

      if (response.ok) {
        const entryCard = document.createElement('div');
        entryCard.classList.add('entry-card');
        entryCard.innerHTML = `
          <strong>${title}</strong><br>$${amount}
          <div class="entry-details">
            <p><strong>Notes:</strong> ${description || "None"}</p>
            <p><strong>Contributors:</strong><br>${contributors.replace(/\n/g, '<br>').replace(/, ?/g, '<br>')}</p>
          </div>
        `;
        entryList.appendChild(entryCard);

        form.reset();
        closeEntryForm();
      } else {
        alert(result.error || 'Failed to add entry.');
      }
    } catch (err) {
      console.error(err);
      alert('Server error. Please try again later.');
    }
  });

  if (loggedInUser) {
    loadEntries();
  }
</script>  
  <p>
    <em>Tip: Click the "+" card to add a new expense entry. Keep your balances up to date and never forget who owes what!</em>
  </p> 
 </body>    
</html>